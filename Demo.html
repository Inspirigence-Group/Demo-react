<!-- ============================================ -->
<!-- REALTYMATCH CRM - DÉMO COMPLÈTE -->
<!-- Toutes les fonctionnalités du système -->
<!-- ============================================ -->

<style>
    #demo-interactive .glass {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    #demo-interactive .glass-light {
        background: rgba(255, 255, 255, 0.95);
    }
    #demo-interactive .grid-pattern {
        background-image: radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.15) 1px, transparent 1px);
        background-size: 20px 20px;
    }
    #demo-interactive .reveal {
        opacity: 0;
        transform: translateY(20px);
        animation: reveal 0.6s ease forwards;
    }
    @keyframes reveal {
        to { opacity: 1; transform: translateY(0); }
    }
    #demo-interactive .progress-bar {
        background: linear-gradient(90deg, #00d4ff, #7c3aed);
    }
    #demo-interactive .match-gradient {
        background: linear-gradient(135deg, #10b981, #059669);
    }
    #demo-interactive .animate-spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<section id="demo-interactive" class="py-20 lg:py-28 bg-gradient-to-b from-kommo-dark to-[#1a1840] relative overflow-hidden">
    <div class="absolute inset-0 grid-pattern opacity-30"></div>
    
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-10">
            <div class="inline-flex items-center gap-2 px-4 py-2 glass rounded-full mb-6 reveal">
                <span class="iconify w-4 h-4 text-kommo-primary" data-icon="lucide:zap" style="stroke-width: 1.5;"></span>
                <span class="text-sm font-medium text-kommo-primary">Démo interactive - RealtyMatch par Kommo Maroc</span>
            </div>
            <h2 class="text-3xl sm:text-4xl font-bold text-white tracking-tight mb-4 reveal">
                <span class="inline-block bg-gradient-to-r from-kommo-primary via-purple-400 to-kommo-accent bg-clip-text text-transparent animate-pulse hover:scale-105 transition-transform duration-300">
                    Testez l'expérience en 45 secondes
                </span>
                <br>
                <span class="inline-block bg-gradient-to-r from-green-400 via-emerald-400 to-kommo-primary bg-clip-text text-transparent hover:scale-105 transition-transform duration-300">
                    Automatisez 90% de votre travail administratif
                </span>
            </h2>
            <p class="text-lg text-white/60 reveal">
                <span class="inline-flex items-center gap-2 hover:text-white/80 transition-colors duration-300">
                    <span class="inline-block px-2 py-1 bg-kommo-primary/20 rounded-lg text-kommo-primary font-medium hover:bg-kommo-primary/30 transition-colors">
                        Choisissez un lead
                    </span>
                    <span class="text-kommo-primary animate-pulse">→</span>
                    <span class="inline-block px-2 py-1 bg-purple-500/20 rounded-lg text-purple-400 font-medium hover:bg-purple-500/30 transition-colors">
                        Voyez le matching
                    </span>
                    <span class="text-purple-400 animate-pulse">→</span>
                    <span class="inline-block px-2 py-1 bg-emerald-500/20 rounded-lg text-emerald-400 font-medium hover:bg-emerald-500/30 transition-colors">
                        Générez une brochure
                    </span>
                    <span class="text-emerald-400 animate-pulse">→</span>
                    <span class="inline-block px-2 py-1 bg-orange-500/20 rounded-lg text-orange-400 font-medium hover:bg-orange-500/30 transition-colors">
                        Simulez l'envoi
                    </span>
                </span>
            </p>
        </div>

        <!-- Interactive Demo Widget -->
        <div class="glass rounded-3xl border border-white/10 overflow-hidden shadow-2xl reveal">
            <!-- Progress Bar -->
            <div class="p-4 border-b border-white/10 bg-white/5">
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-lg font-medium text-white/80">Progression</span>
                    <span class="text-sm text-white/40" id="demo-step-label">Étape 1 sur 4</span>
                </div>
                <div class="h-2 bg-white/10 rounded-full overflow-hidden">
                    <div id="demo-progress" class="h-full progress-bar rounded-full transition-all duration-500" style="width: 25%"></div>
                </div>
                <div class="flex justify-between mt-2">
                    <span class="text-sm font-medium text-kommo-primary" id="step-ind-1">Import</span>
                    <span class="text-sm text-white/40" id="step-ind-2">Matching IA</span>
                    <span class="text-sm text-white/40" id="step-ind-3">Brochure</span>
                    <span class="text-sm text-white/40" id="step-ind-4">Automatisation</span>
                </div>
            </div>

            <div class="flex flex-col lg:flex-row min-h-[500px] lg:min-h-[550px]">
                <!-- Panel A: Leads & Import <br/> Source de donnée : Kommo -->
                <div id="panel-leads" class="lg:w-1/4 border-r border-white/10 p-4 bg-white/5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-white">Leads & Import <br/> Source de donnée : Kommo</h3>
                        <span class="px-2 py-0.5 bg-kommo-primary/20 text-kommo-primary text-xs font-medium rounded-full">3</span>
                    </div>
                    
                    <!-- Quick Import Section -->
                    <div class="mb-4">
                        <label class="text-xs font-medium text-white/50 mb-2 block">Import Rapide</label>
                        <div class="grid grid-cols-3 gap-1">
                            <button onclick="scrapeFromPlatform('mubawab')" class="py-2 px-1 bg-white/5 hover:bg-orange-500/20 border border-white/10 hover:border-orange-500/30 rounded-lg transition-all flex flex-col items-center gap-1">
                                <div class="w-4 h-4 bg-orange-500 rounded flex items-center justify-center">
                                    <span class="text-white text-xs font-bold">M</span>
                                </div>
                                <span class="text-xs text-white/70">Mubawab</span>
                            </button>
                            <button onclick="scrapeFromPlatform('avito')" class="py-2 px-1 bg-white/5 hover:bg-blue-500/20 border border-white/10 hover:border-blue-500/30 rounded-lg transition-all flex flex-col items-center gap-1">
                                <img src="https://logosarchive.com/wp-content/uploads/2022/03/Avito-logo.png" alt="Avito" class="w-4 h-4 object-contain">
                                <span class="text-xs text-white/70">Avito</span>
                            </button>
                            <button onclick="scrapeFromPlatform('sarouty')" class="py-2 px-1 bg-white/5 hover:bg-green-500/20 border border-white/10 hover:border-green-500/30 rounded-lg transition-all flex flex-col items-center gap-1">
                                <div class="w-4 h-4 bg-green-500 rounded flex items-center justify-center">
                                    <span class="text-white text-xs font-bold">S</span>
                                </div>
                                <span class="text-xs text-white/70">Sarouty</span>
                            </button>
                        </div>
                    </div>
                    
                    <div id="leads-list" class="space-y-3">
                        <!-- Leads injected by JS -->
                    </div>
                    
                    <button onclick="importLead()" class="w-full mt-4 py-2.5 px-4 border border-dashed border-white/20 rounded-xl text-sm font-medium text-white/50 hover:border-kommo-primary hover:text-kommo-primary hover:bg-kommo-primary/10 transition-all flex items-center justify-center gap-2">
                        <span class="iconify w-4 h-4" data-icon="lucide:user-plus" style="stroke-width: 1.5;"></span>
                        Créer un lead
                    </button>
                </div>

                <!-- Panel B: Matching IA & Properties -->
                <div id="panel-matching" class="lg:w-1/2 p-4 border-r border-white/10">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-white">Matching Intelligent + IA</h3>
                        <div class="flex items-center gap-2">
                            <div class="px-2 py-1 bg-purple-500/20 text-purple-400 text-xs font-medium rounded-full flex items-center gap-1">
                                <span class="iconify w-3 h-3" data-icon="lucide:brain" style="stroke-width: 1.5;"></span>
                                IA Activée
                            </div>
                            <button onclick="importProperty()" class="flex items-center gap-1 px-3 py-1.5 bg-kommo-primary text-white text-xs font-medium rounded-lg hover:bg-kommo-secondary transition-colors">
                                <span class="iconify w-3 h-3" data-icon="lucide:plus" style="stroke-width: 1.5;"></span>
                                Importer annonce
                            </button>
                        </div>
                    </div>

                    <!-- Selected Lead Info -->
                    <div id="selected-lead-info" class="p-3 bg-kommo-primary/10 rounded-xl mb-4 border border-kommo-primary/20 hidden">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-kommo-primary to-kommo-secondary flex items-center justify-center text-white font-semibold text-sm" id="selected-lead-avatar">--</div>
                            <div class="flex-1">
                                <div class="text-sm font-semibold text-white" id="selected-lead-name">Sélectionnez un lead</div>
                                <div class="text-xs text-white/50" id="selected-lead-criteria">--</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-white/40">Budget</div>
                                <div class="text-sm font-semibold text-kommo-accent" id="selected-lead-budget">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="matching-empty" class="flex flex-col items-center justify-center py-16 text-center">
                        <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center mb-4">
                            <span class="iconify w-8 h-8 text-white/20" data-icon="lucide:brain" style="stroke-width: 1.5;"></span>
                        </div>
                        <p class="text-sm text-white/40 mb-2">Sélectionnez un lead pour activer le matching IA</p>
                        <p class="text-xs text-white/30">L'IA analysera le budget, les critères et les conversations passées</p>
                    </div>

                    <!-- Matched Properties -->
                    <div id="matched-properties" class="space-y-3 hidden">
                        <!-- Properties injected by JS -->
                    </div>
                </div>

                <!-- Panel C: Automatisation -->
                <div id="panel-envoi" class="lg:w-1/4 p-4 bg-white/5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-semibold text-white">Automatisation</h3>
                        <div class="px-2 py-1 bg-green-500/20 text-green-400 text-xs font-medium rounded-full flex items-center gap-1">
                            <span class="iconify w-3 h-3" data-icon="lucide:zap" style="stroke-width: 1.5;"></span>
                            Actif
                        </div>
                    </div>

                    <!-- Brochure Preview -->
                    <div id="brochure-preview" class="mb-4 hidden">
                        <div class="relative glass-light rounded-xl overflow-hidden shadow-lg">
                            <div class="aspect-[3/4] p-3 flex flex-col">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <div class="w-5 h-5 rounded bg-gradient-to-br from-kommo-primary to-kommo-secondary"></div>
                                        <span class="text-xs font-semibold text-kommo-dark">Inspirigence Real Estate</span>
                                    </div>
                                    <div class="px-2 py-0.5 bg-kommo-primary text-white text-xs font-bold rounded">Premium</div>
                                </div>
                                <div id="brochure-image" class="flex-1 bg-gray-200 rounded-lg mb-2 flex items-center justify-center overflow-hidden">
                                    <span class="iconify w-6 h-6 text-gray-300" data-icon="lucide:image" style="stroke-width: 1.5;"></span>
                                </div>
                                <div class="space-y-1">
                                    <div id="brochure-title" class="text-xs font-semibold text-gray-900 truncate">--</div>
                                    <div id="brochure-details" class="text-xs text-gray-500">--</div>
                                    <div id="brochure-price" class="text-sm font-bold text-kommo-primary">--</div>
                                    <div class="text-xs text-gray-400">PDF Brandé • Haute qualité</div>
                                </div>
                            </div>
                            <div class="absolute top-2 right-2 px-2 py-0.5 bg-kommo-success text-white text-xs font-bold rounded">PDF</div>
                        </div>
                        <button onclick="sendBrochure()" id="send-btn" class="w-full mt-3 py-2.5 px-4 bg-gradient-to-r from-green-500 to-green-600 text-white text-sm font-medium rounded-xl hover:shadow-lg hover:shadow-green-500/30 transition-all flex items-center justify-center gap-2">
                            <span class="iconify w-4 h-4" data-icon="lucide:send" style="stroke-width: 1.5;"></span>
                            Envoyer via WhatsApp
                        </button>
                        
                        <!-- Phone Number Input -->
                        <div class="mt-3">
                            <label class="text-xs font-medium text-white/50 mb-1 block">Numéro WhatsApp personnalisé</label>
                            <div class="flex gap-2">
                                <input 
                                    type="tel" 
                                    id="whatsapp-number" 
                                    placeholder="+212600000000" 
                                    class="flex-1 px-3 py-2 bg-white/10 border border-white/20 rounded-lg text-white text-sm placeholder-white/40 focus:outline-none focus:border-kommo-primary/50 focus:bg-white/15 transition-all"
                                    pattern="[+][0-9]{1,15}"
                                >
                                <button 
                                    onclick="sendBrochureToCustomNumber()" 
                                    class="px-3 py-2 bg-kommo-primary/20 hover:bg-kommo-primary/30 text-kommo-primary rounded-lg transition-all flex items-center gap-1"
                                    title="Envoyer à ce numéro"
                                >
                                    <span class="iconify w-4 h-4" data-icon="lucide:send" style="stroke-width: 1.5;"></span>
                                </button>
                            </div>
                            <p class="text-xs text-white/30 mt-1">Format: +212XXXXXXXXX</p>
                        </div>
                    </div>

                    <!-- Empty Brochure -->
                    <div id="brochure-empty" class="p-6 border border-dashed border-white/20 rounded-xl text-center mb-4">
                        <span class="iconify w-8 h-8 text-white/20 mx-auto mb-2" data-icon="lucide:file-text" style="stroke-width: 1.5;"></span>
                        <p class="text-xs text-white/40">Sélectionnez un bien pour générer une brochure</p>
                    </div>

                    <!-- Documents Section -->
                    <div class="mb-4">
                        <label class="text-xs font-medium text-white/50 mb-2 block">Documents</label>
                        <div id="documents-list" class="space-y-2">
                            <div class="document-item flex items-center gap-2 p-2 glass rounded-lg border border-white/10 cursor-pointer hover:border-kommo-primary/50 transition-all" onclick="previewDocument('compromis')">
                                <div class="w-8 h-8 rounded bg-red-500/20 flex items-center justify-center">
                                    <span class="iconify w-4 h-4 text-red-400" data-icon="lucide:file-text" style="stroke-width: 1.5;"></span>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-white/80">Compromis de vente</div>
                                    <div class="text-xs text-white/40">PDF • 2.4 MB</div>
                                </div>
                                <span class="iconify w-4 h-4 text-white/30" data-icon="lucide:eye" style="stroke-width: 1.5;"></span>
                            </div>
                            <div class="document-item flex items-center gap-2 p-2 glass rounded-lg border border-white/10 cursor-pointer hover:border-kommo-primary/50 transition-all" onclick="previewDocument('mandat')">
                                <div class="w-8 h-8 rounded bg-blue-500/20 flex items-center justify-center">
                                    <span class="iconify w-4 h-4 text-blue-400" data-icon="lucide:file-check" style="stroke-width: 1.5;"></span>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-white/80">Mandat de vente</div>
                                    <div class="text-xs text-white/40">PDF • 1.8 MB</div>
                                </div>
                                <span class="iconify w-4 h-4 text-white/30" data-icon="lucide:eye" style="stroke-width: 1.5;"></span>
                            </div>
                            <div class="document-item flex items-center gap-2 p-2 glass rounded-lg border border-white/10 cursor-pointer hover:border-kommo-primary/50 transition-all" onclick="previewDocument('attestation')">
                                <div class="w-8 h-8 rounded bg-green-500/20 flex items-center justify-center">
                                    <span class="iconify w-4 h-4 text-green-400" data-icon="lucide:badge-check" style="stroke-width: 1.5;"></span>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-white/80">Attestation propriété</div>
                                    <div class="text-xs text-white/40">PDF • 890 KB</div>
                                </div>
                                <span class="iconify w-4 h-4 text-white/30" data-icon="lucide:eye" style="stroke-width: 1.5;"></span>
                            </div>
                        </div>
                    </div>

                    <!-- WhatsApp Automation -->
                    <div class="mb-4">
                        <label class="text-xs font-medium text-white/50 mb-2 block text-center">Vivez l'expérience (en accéléré) <br> WhatsApp Automation</label>
                        <div id="timeline" class="space-y-2">
                            <div class="timeline-item flex items-center gap-2 p-2 glass rounded-lg border border-white/10">
                                <div class="w-6 h-6 rounded-full bg-kommo-success flex items-center justify-center">
                                    <span class="iconify w-3 h-3 text-white" data-icon="lucide:check" style="stroke-width: 2;"></span>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-white/80">J1 - Brochure envoyée</div>
                                    <div class="text-xs text-white/40">WhatsApp Automatique</div>
                                </div>
                            </div>
                            <div class="timeline-item flex items-center gap-2 p-2 glass rounded-lg border border-white/10 opacity-50">
                                <div class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center">
                                    <span class="iconify w-3 h-3 text-white/50" data-icon="lucide:clock" style="stroke-width: 1.5;"></span>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-white/50">J2 - Suivi personnalisé</div>
                                    <div class="text-xs text-white/30">IA Analysis</div>
                                </div>
                            </div>
                            <div class="timeline-item flex items-center gap-2 p-2 glass rounded-lg border border-white/10 opacity-50">
                                <div class="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center">
                                    <span class="iconify w-3 h-3 text-white/50" data-icon="lucide:clock" style="stroke-width: 1.5;"></span>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-white/50">J4 - Témoignage client</div>
                                    <div class="text-xs text-white/30">Smart Content</div>
                                </div>
                            </div>
                        </div>
                        <button onclick="simulateRelance()" class="w-full mt-2 py-2 px-3 border border-white/20 rounded-lg text-xs font-medium text-white/60 hover:border-kommo-primary hover:text-kommo-primary transition-colors">
                            Simuler automation
                        </button>
                    </div>      
                                    </div>
            </div>

            <!-- Info Bar -->
            <div class="p-4 bg-kommo-primary/10 border-t border-kommo-primary/20 flex flex-col sm:flex-row items-center justify-between gap-3">
                <p class="text-xs text-white/70 flex items-center gap-2">
                    <span class="iconify w-4 h-4 text-kommo-primary" data-icon="lucide:info" style="stroke-width: 1.5;"></span>
                    Démo complète RealtyMatch - Scraping • IA • Automatisation • Sync Cloud
                </p>
                <a href="#packages" class="text-xs font-medium text-kommo-primary hover:underline flex items-center gap-1">
                    Voir les packs
                    <span class="iconify w-3 h-3" data-icon="lucide:arrow-right" style="stroke-width: 1.5;"></span>
                </a>
            </div>
        </div>
    </div>

    <!-- Document Preview Modal -->
    <div id="document-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4" onclick="closeDocumentModal(event)">
        <div class="bg-[#1a1840] rounded-2xl border border-white/10 w-full max-w-2xl max-h-[80vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between p-4 border-b border-white/10">
                <div class="flex items-center gap-3">
                    <div id="modal-doc-icon" class="w-10 h-10 rounded bg-red-500/20 flex items-center justify-center">
                        <span class="iconify w-5 h-5 text-red-400" data-icon="lucide:file-text" style="stroke-width: 1.5;"></span>
                    </div>
                    <div>
                        <div id="modal-doc-title" class="text-sm font-semibold text-white">Compromis de vente</div>
                        <div id="modal-doc-info" class="text-xs text-white/50">PDF • 2.4 MB • Généré automatiquement</div>
                    </div>
                </div>
                <button onclick="closeDocumentModal()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                    <span class="iconify w-5 h-5 text-white/60" data-icon="lucide:x" style="stroke-width: 1.5;"></span>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[60vh]">
                <div id="modal-doc-content" class="bg-white rounded-xl p-6 text-gray-800">
                    <!-- Document preview content will be injected here -->
                </div>
            </div>
            <div class="flex items-center justify-end gap-3 p-4 border-t border-white/10">
                <button onclick="closeDocumentModal()" class="px-4 py-2 text-sm font-medium text-white/60 hover:text-white transition-colors">
                    Fermer
                </button>
                <button class="px-4 py-2 bg-kommo-primary text-white text-sm font-medium rounded-lg hover:bg-kommo-secondary transition-colors flex items-center gap-2">
                    <span class="iconify w-4 h-4" data-icon="lucide:download" style="stroke-width: 1.5;"></span>
                    Télécharger
                </button>
            </div>
        </div>
    </div>
</section>

<script>
// Global function for button - outside IIFE to ensure global scope
window.simulateRelance = function() {
    console.log('simulateRelance called - Starting automation simulation');
    
    try {
        const timelineItems = document.querySelectorAll('#timeline .timeline-item');
        console.log('Timeline items found:', timelineItems.length);
        
        if (timelineItems.length === 0) {
            console.error('No timeline items found!');
            // Use alert if showNotification is not available yet
            if (typeof showNotification === 'function') {
                showNotification('Erreur: Aucun élément de timeline trouvé', 'error');
            } else {
                alert('Erreur: Aucun élément de timeline trouvé');
            }
            return;
        }
        
        let completed = 0;
        
        const interval = setInterval(() => {
            if (completed >= timelineItems.length) {
                clearInterval(interval);
                if (typeof showNotification === 'function') {
                    showNotification('Automation WhatsApp complétée avec IA !');
                } else {
                    alert('Automation WhatsApp complétée avec IA !');
                }
                
                                return;
            }
            
            const item = timelineItems[completed];
            console.log('Processing timeline item', completed);
            
            item.classList.remove('opacity-50');
            const icon = item.querySelector('.w-6');
            if (icon) {
                icon.classList.remove('bg-white/10');
                icon.classList.add('bg-kommo-success');
                icon.innerHTML = '<span class="iconify w-3 h-3 text-white" data-icon="lucide:check" style="stroke-width: 2;"></span>';
            }
            
            completed++;
        }, 800);
    } catch (error) {
        console.error('Error in simulateRelance:', error);
        if (typeof showNotification === 'function') {
            showNotification('Erreur lors de la simulation: ' + error.message, 'error');
        } else {
            alert('Erreur lors de la simulation: ' + error.message);
        }
    }
};

// Test function
window.testButton = function() {
    console.log('testButton called!');
    alert('Button clicked successfully!');
    
    // Try to call the original function
    if (typeof window.simulateRelance === 'function') {
        console.log('simulateRelance exists, calling it...');
        window.simulateRelance();
    } else {
        console.error('simulateRelance does not exist!');
        alert('simulateRelance function not found!');
    }
};

(function() {
    // ========== DATA ==========
    const demoLeads = [
        { 
            id: 1, 
            name: 'Youssef El Amrani', 
            initials: 'YE', 
            criteria: 'F3 Maarif, Parking, Proche tram', 
            budget: { min: 1500000, max: 2500000 },
            budgetDisplay: '2M MAD', 
            source: 'whatsapp',
            chatHistory: ['cherche F3 quartier calme', 'budget flexible si bien parfait', 'aime les terrasses'],
            aiProfile: 'Professionnel, cherche bien lumineux, priorise la localisation',
            preferences: {
                type: 'F3',
                location: 'Maarif',
                features: ['parking', 'terrasse', 'proximite_transport'],
                priority: 'localisation'
            }
        },
        { 
            id: 2, 
            name: 'Fatima Zahra', 
            initials: 'FZ', 
            criteria: 'Villa Anfa, Piscine, 4+ chambres', 
            budget: { min: 4000000, max: 6000000 },
            budgetDisplay: '5M MAD', 
            source: 'instagram',
            chatHistory: ['famille avec enfants', 'besoin jardin', 'sécurité importante'],
            aiProfile: 'Famille aisée, recherche espace et confort, priorise écoles',
            preferences: {
                type: 'Villa',
                location: 'Anfa',
                features: ['piscine', 'jardin', 'securite', 'ecoles_proches'],
                minRooms: 4,
                priority: 'espace'
            }
        },
        { 
            id: 3, 
            name: 'Omar Benjelloun', 
            initials: 'OB', 
            criteria: 'Studio Gauthier, Investissement locatif', 
            budget: { min: 600000, max: 1000000 },
            budgetDisplay: '800K MAD', 
            source: 'facebook',
            chatHistory: ['premier investissement', 'bon rendement locatif', 'peu d entretien'],
            aiProfile: 'Investisseur débutant, recherche rentabilité, prudent',
            preferences: {
                type: 'Studio',
                location: 'Gauthier',
                features: ['meuble', 'rendement_locatif', 'facile_entretien'],
                priority: 'rentabilite'
            }
        }
    ];

    // Pool global de biens immobiliers
    const globalProperties = [
        // Appartements F3/F4
        {
            id: 1,
            title: 'Appartement F3 Maarif Premium',
            type: 'F3',
            location: 'Maarif',
            price: 1800000,
            area: 120,
            rooms: 3,
            features: ['parking', 'terrasse', 'proximite_transport', 'lumineux'],
            details: '120m² • 3 pièces • Parking • Terrasse • Proche tram',
            img: 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'mubawab'
        },
        {
            id: 2,
            title: 'F4 Racine Vue Mer',
            type: 'F4',
            location: 'Racine',
            price: 2200000,
            area: 150,
            rooms: 4,
            features: ['terrasse', 'vue_mer', 'lumineux'],
            details: '150m² • 4 pièces • Terrasse • Vue mer',
            img: 'https://images.unsplash.com/photo-1600607687939-ce8a6c25418a?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'avito'
        },
        {
            id: 3,
            title: 'F3 Boulevard Nouveau',
            type: 'F3',
            location: 'Boulevard',
            price: 1600000,
            area: 110,
            rooms: 3,
            features: ['renove', 'calme'],
            details: '110m² • 3 pièces • Rénové neuf',
            img: 'https://images.unsplash.com/photo-1600566753376-12c8ac723b80?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'sarouty'
        },
        {
            id: 4,
            title: 'F3 Gauthier Centre',
            type: 'F3',
            location: 'Gauthier',
            price: 1400000,
            area: 100,
            rooms: 3,
            features: ['centre_commercial', 'proximite_transport'],
            details: '100m² • 3 pièces • Centre commercial • Proche transport',
            img: 'https://images.unsplash.com/photo-1570129477492-45c003edd2be?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'mubawab'
        },
        {
            id: 5,
            title: 'F3 Anfa Residence',
            type: 'F3',
            location: 'Anfa',
            price: 2500000,
            area: 130,
            rooms: 3,
            features: ['terrasse', 'concierge', 'securite'],
            details: '130m² • 3 pièces • Terrasse • Concierge • Sécurité',
            img: 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'avito'
        },
        // Villas
        {
            id: 6,
            title: 'Villa Anfa Supérieur',
            type: 'Villa',
            location: 'Anfa',
            price: 4800000,
            area: 450,
            rooms: 6,
            features: ['piscine', 'jardin', 'securite', 'ecoles_proches', 'garage'],
            details: '450m² • 6 pièces • Piscine • Jardin • Sécurité • Écoles',
            img: 'https://images.unsplash.com/photo-1580587771525-78b9dba3b914?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'mubawab'
        },
        {
            id: 7,
            title: 'Villa Californie Luxe',
            type: 'Villa',
            location: 'Californie',
            price: 5200000,
            area: 380,
            rooms: 5,
            features: ['piscine', 'jardin', 'ecoles_proches', 'terrain_sport'],
            details: '380m² • 5 pièces • Piscine • Jardin • Écoles • Terrain sport',
            img: 'https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'avito'
        },
        {
            id: 8,
            title: 'Villa CIL Moderne',
            type: 'Villa',
            location: 'CIL',
            price: 4500000,
            area: 320,
            rooms: 4,
            features: ['piscine', 'architecture_moderne', 'domotique'],
            details: '320m² • 4 pièces • Piscine • Architecture moderne • Domotique',
            img: 'https://images.unsplash.com/photo-1600210482481-3d61b85948c2?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'claren'
        },
        {
            id: 9,
            title: 'Villa Maarif Palace',
            type: 'Villa',
            location: 'Maarif',
            price: 6500000,
            area: 500,
            rooms: 7,
            features: ['piscine', 'jardin', 'garage_multiple', 'spa', 'cinema'],
            details: '500m² • 7 pièces • Piscine • Jardin • Garage multiple • Spa',
            img: 'https://images.unsplash.com/photo-1600607687939-ce8a6c25418a?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'claren'
        },
        // Studios
        {
            id: 10,
            title: 'Studio Gauthier Centre',
            type: 'Studio',
            location: 'Gauthier',
            price: 750000,
            area: 45,
            rooms: 1,
            features: ['meuble', 'proximite_commerces', 'rendement_eleve'],
            details: '45m² • 1 pièce • Meublé • Proche commerces',
            img: 'https://images.unsplash.com/photo-1570129477492-45c003edd2be?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'mubawab'
        },
        {
            id: 11,
            title: 'Studio Maarif Rénové',
            type: 'Studio',
            location: 'Maarif',
            price: 820000,
            area: 50,
            rooms: 1,
            features: ['renove', 'zone_etudiante', 'calme'],
            details: '50m² • 1 pièce • Rénové • Zone étudiante',
            img: 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'avito'
        },
        {
            id: 12,
            title: 'Studio Racine Invest',
            type: 'Studio',
            location: 'Racine',
            price: 680000,
            area: 40,
            rooms: 1,
            features: ['meuble', 'rendement_locatif', 'facile_entretien'],
            details: '40m² • 1 pièce • Meublé • Investissement locatif',
            img: 'https://images.unsplash.com/photo-1600566753376-12c8ac723b80?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'sarouty'
        },
        {
            id: 13,
            title: 'Studio Anfa Business',
            type: 'Studio',
            location: 'Anfa',
            price: 950000,
            area: 55,
            rooms: 1,
            features: ['business_district', 'securite', 'prestige'],
            details: '55m² • 1 pièce • Quartier d\'affaires • Sécurité',
            img: 'https://images.unsplash.com/photo-1600607687939-ce8a6c25418a?w=400&h=300&fit=crop&auto=format',
            scrapedFrom: 'claren'
        }
    ];

    // Ancien système conservé pour compatibilité
    const demoProperties = {};

    // Scraping results cache
    let scrapedProperties = [];
    let scrapingInProgress = false;

    // ========== STATE ==========
    let selectedLead = null;
    let selectedProperty = null;
    let currentStep = 1;

    // ========== STATIC MATCHING ==========
    // Listes statiques de 3 biens pour chaque lead - Marché Marocain
    const staticProperties = {
        1: [ // Youssef El Amrani - F3 Maarif
            { 
                propertyId: 'youssef_1', 
                title: 'Appartement F3 Maarif Premium', 
                details: '120m² • 3 pièces • Parking • Terrasse • Proche tram', 
                price: '1.8M MAD', 
                match: 94, 
                aiMatch: 96,
                matchReasons: ['Type parfait', 'Budget OK', 'Localisation idéale', 'Parking demandé'],
                img: 'https://images.pexels.com/photos/1571460/pexels-photo-1571460.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&fit=crop',
                scrapedFrom: 'mubawab',
                duplicate: false
            },
            { 
                propertyId: 'youssef_2', 
                title: 'F3 Boulevard Mohammed V', 
                details: '110m² • 3 pièces • Rénové neuf • Quartier calme', 
                price: '1.6M MAD', 
                match: 78,
                aiMatch: 82,
                matchReasons: ['Type F3', 'Bon prix', 'Rénové récemment'],
                img: 'https://images.pexels.com/photos/1643383/pexels-photo-1643383.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&fit=crop',
                scrapedFrom: 'sarouty',
                duplicate: false
            },
            { 
                propertyId: 'youssef_3', 
                title: 'F3 Gauthier Twin Center', 
                details: '100m² • 3 pièces • Vue Twin Center • Proche transport', 
                price: '1.4M MAD', 
                match: 72,
                aiMatch: 75,
                matchReasons: ['Type compatible', 'Centre commercial', 'Bon rapport'],
                img: 'https://images.pexels.com/photos/1918291/pexels-photo-1918291.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&fit=crop',
                scrapedFrom: 'mubawab',
                duplicate: true
            }
        ],
        2: [ // Fatima Zahra - Villa Anfa
            { 
                propertyId: 'fatima_1', 
                title: 'Villa Anfa Supérieur', 
                details: '450m² • 6 pièces • Piscine • Jardin • Gardien 24h', 
                price: '4.8M MAD', 
                match: 96,
                aiMatch: 98,
                matchReasons: ['Villa parfaite', 'Budget idéal', 'Piscine', '6 chambres'],
                img: 'https://images.pexels.com/photos/53610/large-home-residential-702/pexels-photo-53610.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&fit=crop',
                scrapedFrom: 'mubawab',
                duplicate: false
            },
            { 
                propertyId: 'fatima_2', 
                title: 'Villa Californie Prestige', 
                details: '380m² • 5 pièces • Piscine • Jardin • Écoles OSUI', 
                price: '5.2M MAD', 
                match: 85,
                aiMatch: 88,
                matchReasons: ['Villa prestige', 'Piscine', 'Écoles françaises'],
                img: 'https://images.pexels.com/photos/106399/pexels-photo-106399.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&fit=crop',
                scrapedFrom: 'avito',
                duplicate: false
            },
            { 
                propertyId: 'fatima_3', 
                title: 'Villa CIL Bouskoura', 
                details: '320m² • 4 pièces • Piscine • Golf Royal', 
                price: '4.5M MAD', 
                match: 80,
                aiMatch: 83,
                matchReasons: ['Villa moderne', 'Proche Golf', 'Quartier sécurisé'],
                img: 'https://images.pexels.com/photos/1396122/pexels-photo-1396122.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&fit=crop',
                scrapedFrom: 'sarouty',
                duplicate: false
            }
        ],
        3: [ // Omar Benjelloun - Studio Gauthier
            { 
                propertyId: 'omar_1', 
                title: 'Studio Gauthier Centre', 
                details: '45m² • 1 pièce • Meublé • Proche Morocco Mall', 
                price: '750K MAD', 
                match: 92,
                aiMatch: 95,
                matchReasons: ['Studio parfait', 'Budget investissement', 'Meublé', 'Locatif facile'],
                img: 'https://images.pexels.com/photos/1457842/pexels-photo-1457842.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&fit=crop',
                scrapedFrom: 'mubawab',
                duplicate: false
            },
            { 
                propertyId: 'omar_2', 
                title: 'Studio Maarif Extension', 
                details: '50m² • 1 pièce • Rénové • Zone étudiante', 
                price: '820K MAD', 
                match: 76,
                aiMatch: 79,
                matchReasons: ['Studio rénové', 'Zone étudiante', 'Bon potentiel'],
                img: 'https://images.pexels.com/photos/1648776/pexels-photo-1648776.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&fit=crop',
                scrapedFrom: 'avito',
                duplicate: false
            },
            { 
                propertyId: 'omar_3', 
                title: 'Studio Racine Corniche', 
                details: '40m² • 1 pièce • Meublé • Vue mer partielle', 
                price: '680K MAD', 
                match: 88,
                aiMatch: 91,
                matchReasons: ['Studio investissement', 'Prix attractif', 'Rendement 8%'],
                img: 'https://images.pexels.com/photos/1743227/pexels-photo-1743227.jpeg?auto=compress&cs=tinysrgb&w=400&h=300&fit=crop',
                scrapedFrom: 'sarouty',
                duplicate: false
            }
        ]
    };

    // ========== INIT ==========
    function initDemo() {
        renderLeads();
    }

    function renderLeads() {
        const leadsList = document.getElementById('leads-list');
        if (!leadsList) return;
        
        leadsList.innerHTML = demoLeads.map(lead => `
            <div class="lead-card p-3 glass rounded-xl border border-white/10 cursor-pointer hover:border-kommo-primary/50 transition-all" data-lead-id="${lead.id}" onclick="window.selectLead(${lead.id})">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-kommo-primary to-kommo-secondary flex items-center justify-center text-white font-semibold text-sm">${lead.initials}</div>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm font-medium text-white truncate">${lead.name}</div>
                        <div class="text-xs text-white/50">${lead.criteria}</div>
                        <div class="flex items-center gap-1 mt-1">
                            <span class="iconify w-3 h-3 text-purple-400" data-icon="lucide:brain" style="stroke-width: 1.5;"></span>
                            <span class="text-xs text-purple-400">IA Profile</span>
                        </div>
                    </div>
                    <span class="px-2 py-0.5 ${getSourceClass(lead.source)} text-xs font-medium rounded-full">${lead.source}</span>
                </div>
            </div>
        `).join('');
    }

    function getSourceClass(source) {
        switch(source) {
            case 'whatsapp': return 'bg-green-500/20 text-green-400';
            case 'instagram': return 'bg-pink-500/20 text-pink-400';
            case 'facebook': return 'bg-blue-500/20 text-blue-400';
            default: return 'bg-white/10 text-white/50';
        }
    }

    // ========== LEAD SELECTION ==========
    window.selectLead = function(id) {
        console.log('=== SELECT LEAD CALLED WITH ID:', id, '===');
        selectedLead = demoLeads.find(l => l.id === id);
        if (!selectedLead) {
            console.log('ERROR: Lead not found for ID:', id);
            return;
        }
        
        console.log('Selected lead:', selectedLead.name);

        // Update lead cards visual
        document.querySelectorAll('.lead-card').forEach(card => {
            card.classList.remove('border-kommo-primary');
            card.classList.add('border-white/10');
        });
        document.querySelector(`.lead-card[data-lead-id="${id}"]`)?.classList.add('border-kommo-primary');
        document.querySelector(`.lead-card[data-lead-id="${id}"]`)?.classList.remove('border-white/10');

        // Show selected lead info with AI insights
        document.getElementById('selected-lead-info').classList.remove('hidden');
        document.getElementById('selected-lead-avatar').textContent = selectedLead.initials;
        document.getElementById('selected-lead-name').textContent = selectedLead.name;
        document.getElementById('selected-lead-criteria').textContent = selectedLead.criteria;
        document.getElementById('selected-lead-budget').textContent = selectedLead.budgetDisplay;

        // Hide empty state, show properties
        document.getElementById('matching-empty').classList.add('hidden');
        document.getElementById('matched-properties').classList.remove('hidden');

        // Render matched properties using the new intelligent matching
        console.log('About to call renderProperties with ID:', id);
        renderProperties(id);

        // Update progress
        updateProgress(2);
    };

    function renderProperties(leadId) {
        const container = document.getElementById('matched-properties');
        
        // DEBUG: Afficher quel lead est sélectionné
        console.log('=== RENDER PROPERTIES FOR LEAD:', leadId, '===');
        console.log('Available staticProperties keys:', Object.keys(staticProperties));
        console.log('Properties for this lead:', staticProperties[leadId]);
        
        // Forcer le vidage complet du conteneur
        container.innerHTML = '';
        
        // Utiliser les listes statiques simples
        const properties = staticProperties[leadId] || [];
        console.log('Final properties array:', properties);

        if (properties.length === 0) {
            container.innerHTML = '<div class="text-white/50 text-center p-4">Aucun bien trouvé pour ce lead</div>';
            return;
        }

        container.innerHTML = properties.map(prop => `
            <div class="property-card p-3 glass rounded-xl border border-white/10 cursor-pointer hover:border-kommo-primary/50 transition-all" data-property-id="${prop.propertyId}" onclick="window.selectProperty('${prop.propertyId}', ${leadId})">
                <div class="flex items-start gap-3">
                    <div class="w-16 h-12 rounded-lg overflow-hidden flex-shrink-0">
                        <img src="${prop.img}" alt="${prop.title}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="text-sm font-medium text-white truncate">${prop.title}</div>
                            ${prop.duplicate ? '<span class="px-1.5 py-0.5 bg-orange-500/20 text-orange-400 text-xs font-medium rounded">Doublon</span>' : ''}
                            <span class="px-1.5 py-0.5 bg-blue-500/20 text-blue-400 text-xs font-medium rounded">${prop.scrapedFrom}</span>
                        </div>
                        <div class="text-xs text-white/50">${prop.details}</div>
                        <div class="flex flex-wrap gap-1 mt-1">
                            ${prop.matchReasons.slice(0, 2).map(reason => `<span class="text-xs text-purple-300">• ${reason}</span>`).join('')}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-bold text-kommo-primary">${prop.price}</div>
                        <div class="px-2 py-0.5 ${prop.aiMatch >= 90 ? 'bg-purple-500/20 text-purple-400' : prop.match >= 90 ? 'match-gradient' : 'bg-white/10'} text-white text-xs font-bold rounded flex items-center gap-1">
                            <span class="iconify w-3 h-3" data-icon="lucide:brain" style="stroke-width: 1.5;"></span>
                            ${prop.aiMatch}% IA
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        console.log('Container HTML after render:', container.innerHTML.length, 'characters');
    }

    // ========== PROPERTY SELECTION ==========
    window.selectProperty = function(propertyId, leadId) {
        // Utiliser les listes statiques pour trouver les propriétés
        const properties = staticProperties[leadId] || [];
        selectedProperty = properties.find(p => p.propertyId === propertyId);
        if (!selectedProperty) return;

        // Update property cards visual
        document.querySelectorAll('.property-card').forEach(card => {
            card.classList.remove('border-kommo-primary');
            card.classList.add('border-white/10');
        });
        document.querySelector(`.property-card[data-property-id="${propertyId}"]`)?.classList.add('border-kommo-primary');
        document.querySelector(`.property-card[data-property-id="${propertyId}"]`)?.classList.remove('border-white/10');

        // Show brochure preview
        document.getElementById('brochure-empty').classList.add('hidden');
        document.getElementById('brochure-preview').classList.remove('hidden');
        document.getElementById('brochure-image').innerHTML = `<img src="${selectedProperty.img}" class="w-full h-full object-cover">`;
        document.getElementById('brochure-title').textContent = selectedProperty.title;
        document.getElementById('brochure-details').textContent = selectedProperty.details;
        document.getElementById('brochure-price').textContent = selectedProperty.price;

        // Update progress
        updateProgress(3);
    };

    // ========== SCRAPING FUNCTIONS ==========
    window.scrapeFromPlatform = function(platform) {
        if (scrapingInProgress) return;
        
        scrapingInProgress = true;
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        
        button.innerHTML = '<span class="iconify w-4 h-4 animate-spin" data-icon="lucide:loader-2" style="stroke-width: 1.5;"></span><span class="text-xs">Scraping...</span>';
        button.disabled = true;
        
        setTimeout(() => {
            const newProperties = generateScrapedProperties(platform);
            scrapedProperties = [...scrapedProperties, ...newProperties];
            
            button.innerHTML = '<span class="iconify w-4 h-4 text-green-400" data-icon="lucide:check" style="stroke-width: 1.5;"></span><span class="text-xs">+' + newProperties.length + '</span>';
            
            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
                scrapingInProgress = false;
            }, 2000);
        }, 2000);
    };
    
    function generateScrapedProperties(platform) {
        const platformImages = {
            'Mubawab': 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=400&h=300&fit=crop&auto=format',
            'Avito': 'https://images.unsplash.com/photo-1600607687939-ce8a6c25418a?w=400&h=300&fit=crop&auto=format',
            'Sarouty': 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=400&h=300&fit=crop&auto=format'
        };
        
        const newProperties = [
            {
                id: Date.now() + 1,
                title: `Bien scrapé depuis ${platform}`,
                details: 'Scraping automatique • Photos importées',
                price: Math.floor(Math.random() * 3000000 + 500000) + ' MAD',
                match: 85,
                aiMatch: 88,
                matchReasons: ['Scraping IA', 'Analyse automatique'],
                img: platformImages[platform] || platformImages['Mubawab'],
                scrapedFrom: platform,
                duplicate: false
            }
        ];
        
        return newProperties;
    }
    
    // ========== ENHANCED SEND BROCHURE ==========
    window.sendBrochure = function() {
        const btn = document.getElementById('send-btn');
        btn.innerHTML = '<span class="iconify w-4 h-4 animate-spin" data-icon="lucide:loader-2" style="stroke-width: 1.5;"></span> Génération PDF...';
        btn.disabled = true;

        setTimeout(() => {
            btn.innerHTML = '<span class="iconify w-4 h-4 animate-spin" data-icon="lucide:loader-2" style="stroke-width: 1.5;"></span> Envoi WhatsApp...';
            
            setTimeout(() => {
                btn.innerHTML = '<span class="iconify w-4 h-4" data-icon="lucide:check" style="stroke-width: 1.5;"></span> Envoyé !';
                btn.classList.remove('from-green-500', 'to-green-600');
                btn.classList.add('bg-kommo-success');

                
                // Update progress
                updateProgress(4);
                
                // Show success notification
                showNotification('Brochure PDF brandée envoyée via WhatsApp avec succès !');
            }, 1500);
        }, 1500);
    };
    
    // ========== SEND TO CUSTOM NUMBER ==========
    window.sendBrochureToCustomNumber = function() {
        const phoneNumber = document.getElementById('whatsapp-number').value.trim();
        
        // Validation du numéro
        if (!phoneNumber) {
            showNotification('Veuillez entrer un numéro de téléphone', 'error');
            return;
        }
        
        if (!phoneNumber.match(/^\+[0-9]{10,15}$/)) {
            showNotification('Format invalide. Utilisez: +212XXXXXXXXX', 'error');
            return;
        }
        
        // Simulation d'envoi
        const input = document.getElementById('whatsapp-number');
        const button = event.target;
        
        input.disabled = true;
        button.disabled = true;
        button.innerHTML = '<span class="iconify w-4 h-4 animate-spin" data-icon="lucide:loader-2" style="stroke-width: 1.5;"></span>';
        
        setTimeout(() => {
            // Success feedback
            showNotification(`Brochure envoyée à ${phoneNumber} !`);
            
            // Reset form
            input.value = '';
            input.disabled = false;
            button.disabled = false;
            button.innerHTML = '<span class="iconify w-4 h-4" data-icon="lucide:send" style="stroke-width: 1.5;"></span>';
            
                        
            // Update progress
            updateProgress(4);
        }, 2000);
    };
    
    // ========== NOTIFICATION SYSTEM ==========
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
        const icon = type === 'error' ? 'lucide:alert-circle' : 'lucide:check-circle';
        
        notification.className = `fixed top-4 right-4 px-4 py-3 ${bgColor} text-white text-sm font-medium rounded-lg shadow-lg z-50 flex items-center gap-2`;
        notification.innerHTML = `
            <span class="iconify w-4 h-4" data-icon="${icon}" style="stroke-width: 1.5;"></span>
            ${message}
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }
    
    // ========== ENHANCED SIMULATE RELANCE - REMOVED (now global) ==========
    
    // Also expose it globally for debugging
    window.debugSimulateRelance = window.simulateRelance;
    
    // Simple test function - REMOVED (now global)

    // ========== UTILITIES ==========
    function updateProgress(step) {
        currentStep = step;
        document.getElementById('demo-step-label').textContent = `Étape ${step} sur 4`;
        document.getElementById('demo-progress').style.width = `${step * 25}%`;

        // Update step indicators
        for (let i = 1; i <= 4; i++) {
            const ind = document.getElementById(`step-ind-${i}`);
            if (ind) {
                if (i <= step) {
                    ind.classList.remove('text-white/40');
                    ind.classList.add('text-kommo-primary');
                } else {
                    ind.classList.remove('text-kommo-primary');
                    ind.classList.add('text-white/40');
                }
            }
        }
    }

    window.setSendMode = function(mode) {
        document.querySelectorAll('.send-mode-btn').forEach(btn => {
            btn.classList.remove('bg-kommo-primary', 'text-white');
            btn.classList.add('text-white/50');
        });
        const activeBtn = document.querySelector(`.send-mode-btn[data-mode="${mode}"]`);
        if (activeBtn) {
            activeBtn.classList.add('bg-kommo-primary', 'text-white');
            activeBtn.classList.remove('text-white/50');
        }
    };

    
    window.importLead = function() {
        showNotification('Import lead depuis Kommo CRM - API connectée !');
    };

    window.importProperty = function() {
        showNotification('Import multi-plateformes activé : Mubawab, Avito, Sarouty, Claren !');
    };

    // ========== DOCUMENT PREVIEW ==========
    const documentData = {
        compromis: {
            title: 'Compromis de vente',
            info: 'PDF • 2.4 MB • Généré automatiquement',
            iconBg: 'bg-red-500/20',
            iconColor: 'text-red-400',
            icon: 'lucide:file-text',
            content: `
                <div class="text-center mb-6">
                    <div class="text-xl font-bold text-gray-900 mb-2">COMPROMIS DE VENTE</div>
                    <div class="text-sm text-gray-500">Inspirigence Real Estate - Casablanca</div>
                </div>
                <div class="border-t border-gray-200 pt-4 space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Référence:</span>
                        <span class="font-medium">CV-2024-00847</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Date:</span>
                        <span class="font-medium">15 Janvier 2024</span>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="font-semibold mb-2">VENDEUR</div>
                        <div class="text-sm text-gray-600">M. Ahmed Bennani<br>CIN: AB123456<br>Adresse: 45 Rue Maarif, Casablanca</div>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="font-semibold mb-2">ACQUÉREUR</div>
                        <div class="text-sm text-gray-600">M. Youssef El Amrani<br>CIN: CD789012<br>Adresse: 12 Bd Zerktouni, Casablanca</div>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="font-semibold mb-2">BIEN IMMOBILIER</div>
                        <div class="text-sm text-gray-600">Appartement F3 - 120m²<br>Résidence Premium Maarif<br>Titre foncier: TF 45678/C</div>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="font-semibold mb-2">PRIX DE VENTE</div>
                        <div class="text-2xl font-bold text-kommo-primary">1,800,000 MAD</div>
                    </div>
                </div>
            `
        },
        mandat: {
            title: 'Mandat de vente',
            info: 'PDF • 1.8 MB • Signé électroniquement',
            iconBg: 'bg-blue-500/20',
            iconColor: 'text-blue-400',
            icon: 'lucide:file-check',
            content: `
                <div class="text-center mb-6">
                    <div class="text-xl font-bold text-gray-900 mb-2">MANDAT DE VENTE EXCLUSIF</div>
                    <div class="text-sm text-gray-500">Inspirigence Real Estate - Casablanca</div>
                </div>
                <div class="border-t border-gray-200 pt-4 space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600">N° Mandat:</span>
                        <span class="font-medium">MV-2024-00312</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Durée:</span>
                        <span class="font-medium">3 mois renouvelable</span>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="font-semibold mb-2">MANDANT (Propriétaire)</div>
                        <div class="text-sm text-gray-600">M. Ahmed Bennani<br>Téléphone: +212 6 12 34 56 78</div>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="font-semibold mb-2">MANDATAIRE</div>
                        <div class="text-sm text-gray-600">Inspirigence Real Estate<br>RC: 456789 - Casablanca<br>Agent: Mme Sara Idrissi</div>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="font-semibold mb-2">HONORAIRES</div>
                        <div class="text-sm text-gray-600">Commission: 2.5% HT du prix de vente<br>Payable à la signature de l'acte définitif</div>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <div class="text-xs text-blue-600 flex items-center gap-2">
                            <span class="iconify w-4 h-4" data-icon="lucide:shield-check"></span>
                            Document signé électroniquement le 10/01/2024
                        </div>
                    </div>
                </div>
            `
        },
        attestation: {
            title: 'Attestation de propriété',
            info: 'PDF • 890 KB • Conservation foncière',
            iconBg: 'bg-green-500/20',
            iconColor: 'text-green-400',
            icon: 'lucide:badge-check',
            content: `
                <div class="text-center mb-6">
                    <div class="text-xl font-bold text-gray-900 mb-2">ATTESTATION DE PROPRIÉTÉ</div>
                    <div class="text-sm text-gray-500">Conservation Foncière de Casablanca-Anfa</div>
                </div>
                <div class="border-t border-gray-200 pt-4 space-y-4">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Titre Foncier:</span>
                        <span class="font-medium">TF 45678/C</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Date d'établissement:</span>
                        <span class="font-medium">05 Janvier 2024</span>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="font-semibold mb-2">PROPRIÉTAIRE</div>
                        <div class="text-sm text-gray-600">M. Ahmed Bennani<br>Né le 15/03/1975 à Casablanca<br>CIN: AB123456</div>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="font-semibold mb-2">DÉSIGNATION DU BIEN</div>
                        <div class="text-sm text-gray-600">Appartement situé au 3ème étage<br>Résidence Premium, Rue Maarif<br>Superficie: 120 m²<br>Consistance: 3 pièces + cuisine + SDB</div>
                    </div>
                    <div class="border-t border-gray-200 pt-4">
                        <div class="font-semibold mb-2">ORIGINE DE PROPRIÉTÉ</div>
                        <div class="text-sm text-gray-600">Acquisition par acte notarié<br>Me Karim Alaoui - Notaire<br>Date: 20/06/2018</div>
                    </div>
                    <div class="mt-4 p-3 bg-green-50 rounded-lg">
                        <div class="text-xs text-green-600 flex items-center gap-2">
                            <span class="iconify w-4 h-4" data-icon="lucide:check-circle"></span>
                            Aucune hypothèque ni charge inscrite
                        </div>
                    </div>
                </div>
            `
        }
    };

    window.previewDocument = function(docType) {
        const doc = documentData[docType];
        if (!doc) return;

        const modal = document.getElementById('document-modal');
        const iconDiv = document.getElementById('modal-doc-icon');
        const titleEl = document.getElementById('modal-doc-title');
        const infoEl = document.getElementById('modal-doc-info');
        const contentEl = document.getElementById('modal-doc-content');

        // Update icon
        iconDiv.className = 'w-10 h-10 rounded ' + doc.iconBg + ' flex items-center justify-center';
        iconDiv.innerHTML = '<span class="iconify w-5 h-5 ' + doc.iconColor + '" data-icon="' + doc.icon + '" style="stroke-width: 1.5;"></span>';

        // Update content
        titleEl.textContent = doc.title;
        infoEl.textContent = doc.info;
        contentEl.innerHTML = doc.content;

        // Show modal
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    };

    window.closeDocumentModal = function(event) {
        if (event && event.target !== event.currentTarget) return;
        const modal = document.getElementById('document-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    };

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initDemo();
            // Verify simulateRelance is globally available
            console.log('simulateRelance function available:', typeof window.simulateRelance !== 'undefined');
        });
    } else {
        initDemo();
        // Verify simulateRelance is globally available
        console.log('simulateRelance function available:', typeof window.simulateRelance !== 'undefined');
    }
})();
</script>